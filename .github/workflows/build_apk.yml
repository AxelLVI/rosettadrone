name: Build RosettaDrone APK

on:
  push:
    branches: [ master ]
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Create placeholder sdkmanager wrapper
      run: |
        sudo mkdir -p /usr/local/lib/android/sdk/tools/bin
        echo '#!/usr/bin/env bash' | sudo tee /usr/local/lib/android/sdk/tools/bin/sdkmanager > /dev/null
        echo 'echo "Placeholder sdkmanager: will be replaced during workflow." >&2' | sudo tee -a /usr/local/lib/android/sdk/tools/bin/sdkmanager > /dev/null
        echo 'exit 0' | sudo tee -a /usr/local/lib/android/sdk/tools/bin/sdkmanager > /dev/null
        sudo chmod +x /usr/local/lib/android/sdk/tools/bin/sdkmanager

    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '11'

    - name: Install Android command-line tools (sdkmanager)
      run: |
        set -e
        export ANDROID_SDK_ROOT="$HOME/android-sdk"
        export ANDROID_HOME="$ANDROID_SDK_ROOT"
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools"
        cd $HOME
        echo "Downloading commandline tools..."
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip -O cmdline-tools.zip
        unzip -q cmdline-tools.zip -d cmdline-tools-tmp
        mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools/latest"
        mv cmdline-tools-tmp/cmdline-tools/* "$ANDROID_SDK_ROOT/cmdline-tools/latest/"
        rm -rf cmdline-tools.zip cmdline-tools-tmp
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
        echo "PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH" >> $GITHUB_PATH
        # create a symlink at /usr/local/lib/android/sdk for actions that expect ANDROID_HOME at that path
        sudo mkdir -p /usr/local/lib/android
        if [ -e /usr/local/lib/android/sdk ]; then sudo rm -rf /usr/local/lib/android/sdk; fi
        sudo ln -s "$ANDROID_SDK_ROOT" /usr/local/lib/android/sdk
        # create legacy tools/bin/sdkmanager wrapper for actions that expect ${ANDROID_HOME}/tools/bin/sdkmanager
        sudo mkdir -p "$ANDROID_SDK_ROOT/tools/bin"
        if [ -e "$ANDROID_SDK_ROOT/tools/bin/sdkmanager" ]; then sudo rm -f "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"; fi
        sudo ln -s "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager" "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"
        sudo chmod +x "$ANDROID_SDK_ROOT/tools/bin/sdkmanager"

    - name: Accept Android SDK licenses and install platforms/build-tools and NDK
      run: |
        set -e
        SDKMANAGER="$ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager"
        chmod +x "$SDKMANAGER"
        "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --install "platform-tools" "platforms;android-31" "build-tools;31.0.0" "ndk;22.0.7026061"
        yes | "$SDKMANAGER" --sdk_root="$ANDROID_SDK_ROOT" --licenses

    - name: Create keys.xml from secret
      if: ${{ secrets.DJI_APP_KEY != '' }}
      run: |
        mkdir -p app/src/main/res/values
        cat > app/src/main/res/values/keys.xml <<EOF
        <?xml version="1.0" encoding="utf-8"?>
        <resources>
          <string name="dji_key">${{ secrets.DJI_APP_KEY }}</string>
        </resources>
        EOF

    - name: Ensure gradlew is executable
      run: chmod +x ./gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug --no-daemon

    - name: Debug: list build outputs
      run: |
        echo "Printing app build outputs"
        if [ -d app/build ]; then
          find app/build -type f -name '*.apk' -print || true
          ls -R app/build/outputs || true
        else
          echo "app/build not found" >&2 || true
        fi

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: rosettadrone-artifacts
        path: |
          app/build/outputs/apk/**/*.apk
          app/build/outputs/bundle/**/*.aab
          app/build/outputs/**/*.apk
